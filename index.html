<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Gunting Batu Kertas Online</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <!-- Google Fonts for a fun, game-like feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        /* Menggunakan font kustom */
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none; -ms-user-select: none; user-select: none;
        }
        h1, h2, button, .font-title {
            font-family: 'Fredoka One', cursive;
        }
        .screen, .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 2.5rem 2rem;
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            backface-visibility: hidden;
        }
        .screen.hidden, .modal-overlay.hidden {
            opacity: 0; transform: scale(0.95); pointer-events: none;
        }
        .auth-input, .settings-input {
            border: 2px solid #E2E8F0; background-color: #F7FAFC;
            transition: all 0.2s ease-in-out;
        }
        .auth-input:focus, .settings-input:focus {
            outline: none; border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); background-color: white;
        }
        .primary-btn {
            background: linear-gradient(135deg, #FF7E5F, #FEB47B);
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(254, 180, 123, 0.4);
        }
        .primary-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(254, 180, 123, 0.6); }
        .primary-btn:active { transform: translateY(-1px); }
        .primary-btn:disabled {
            opacity: 0.7; cursor: not-allowed; transform: translateY(0);
            box-shadow: 0 4px 15px rgba(254, 180, 123, 0.2);
        }
        .toggle-link { color: #FF7E5F; transition: color 0.2s; }
        .toggle-link:hover { color: #e56241; }
        .loader, .btn-loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #FF7E5F;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        .btn-loader {
            width: 20px; height: 20px; border-width: 3px;
            border-top-color: white; border-left-color: white; border-bottom-color: white;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            padding: 1rem 1.5rem; border-radius: 0.5rem; color: white;
            font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: bottom 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 100;
        }
        #notification.show { bottom: 20px; }
        #qrcode-container { border: 4px solid #f3f3f3; }
        #game-screen { justify-content: space-between; background-color: #F7FAFC; }
        .player-area { width: 100%; text-align: center; }
        .choice-btn {
            background-color: white; border-radius: 50%; padding: 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 1rem;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s;
        }
        .choice-btn:hover { transform: scale(1.1); }
        .choice-btn img { width: 60px; height: 60px; }
        .choice-btn.selected {
            box-shadow: 0 0 0 4px #FF7E5F, 0 6px 20px rgba(255, 126, 95, 0.5);
            transform: scale(1.1);
        }
        .choice-btn.disabled { opacity: 0.5; pointer-events: none; }
        #opponent-choice-display {
            width: 80px; height: 80px; margin: auto; background-color: #E2E8F0;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 3rem; color: #A0AEC0; transition: all 0.3s;
        }
        #opponent-choice-display img { width: 50px; height: 50px; }
        .modal-card {
            background-color: white; border-radius: 1.5rem; padding: 2rem;
            text-align: center; width: 90%; max-width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative;
            transform: scale(0.9); animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .close-btn {
            position: absolute; top: 10px; right: 10px; width: 36px; height: 36px;
            background-color: #F1F5F9; border-radius: 50%; color: #64748B;
            font-size: 1.5rem; line-height: 1; transition: background-color 0.2s, transform 0.2s;
        }
        .close-btn:hover { background-color: #E2E8F0; transform: rotate(90deg); }
        #result-choices-display {
            display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1rem;
        }
        #result-choices-display img { width: 50px; height: 50px; background-color: #F1F5F9; padding: 0.5rem; border-radius: 50%; }
        #round-counter {
            position: absolute; top: 1.25rem; left: 1.25rem;
            font-size: 0.9rem; font-weight: 600; color: #94a3b8;
            background-color: rgba(255,255,255,0.7); backdrop-filter: blur(4px);
            padding: 0.25rem 0.75rem; border-radius: 9999px;
        }
        @keyframes sparkle-in-circle { 
            0%, 100% { opacity: 0; transform: scale(0.5); } 
            50% { opacity: 1; transform: scale(1.2); } 
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-sm h-[80vh] sm:h-[700px] bg-white rounded-3xl shadow-2xl overflow-hidden relative">
        <div id="asset-preloader" class="hidden"></div>
        <div id="loading-screen" class="screen"><div class="loader"></div><p id="loading-text" class="mt-4 text-gray-500">Memuat...</p></div>

        <div id="auth-screen" class="screen hidden">
            <div class="w-full text-center">
                <h1 class="text-5xl text-gray-800 mb-4">GBK Online</h1>
                <p class="text-gray-500 mb-10">Selamat Datang!</p>
                <form id="register-form" class="space-y-4">
                    <input type="email" id="register-email" placeholder="Email Anda" class="w-full rounded-lg auth-input" required>
                    <input type="password" id="register-password" placeholder="Buat Password" class="w-full rounded-lg auth-input" required minlength="6">
                    <input type="text" id="license-code" placeholder="Kode Lisensi" class="w-full rounded-lg auth-input" required>
                    <button type="submit" class="w-full h-[52px] flex justify-center items-center text-white rounded-lg primary-btn text-lg tracking-wider">Daftar</button>
                </form>
                <form id="login-form" class="space-y-4 hidden">
                    <input type="email" id="login-email" placeholder="Email Anda" class="w-full rounded-lg auth-input" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full rounded-lg auth-input" required>
                    <button type="submit" class="w-full h-[52px] flex justify-center items-center text-white rounded-lg primary-btn text-lg tracking-wider">Login</button>
                </form>
                <p class="mt-8 text-sm text-gray-600">
                    <span id="login-prompt">Sudah punya akun? <a href="#" id="show-login" class="font-semibold toggle-link">Login di sini</a></span>
                    <span id="register-prompt" class="hidden">Belum punya akun? <a href="#" id="show-register" class="font-semibold toggle-link">Daftar sekarang</a></span>
                </p>
            </div>
        </div>
        
        <div id="menu-screen" class="screen hidden bg-gray-50">
             <div class="w-full text-center">
                <h2 class="text-4xl text-gray-800 mb-6">Menu Utama</h2>
                <p class="text-gray-600 mb-10">Selamat datang, <br><span id="user-email" class="font-semibold"></span>!</p>
                <button id="create-game-btn" class="w-full h-[52px] flex justify-center items-center text-white rounded-lg primary-btn text-lg tracking-wider mb-4">Buat Game Baru</button>
                <button id="settings-btn" class="w-full py-3 text-gray-600 bg-gray-200 rounded-lg text-lg tracking-wider transition hover:bg-gray-300 mb-4">Pengaturan</button>
                <button id="logout-btn" class="w-full py-3 text-gray-600 bg-gray-200 rounded-lg text-lg tracking-wider transition hover:bg-gray-300">Keluar</button>
            </div>
        </div>

        <div id="waiting-screen" class="screen hidden bg-gray-50">
             <div class="w-full text-center">
                <h2 class="text-3xl text-gray-800 mb-6">Pindai Kode Ini!</h2>
                <p class="text-gray-600 mb-8">Minta lawanmu untuk memindai QR Code di bawah ini untuk memulai.</p>
                <div id="qrcode-container" class="p-4 bg-white rounded-lg shadow-md inline-block"><div id="qrcode"></div></div>
                <p class="mt-8 text-gray-500 animate-pulse">Menunggu lawan bergabung...</p>
                <button id="back-to-menu-btn" class="mt-10 w-full max-w-xs mx-auto py-3 text-gray-600 bg-gray-200 rounded-lg text-lg tracking-wider transition hover:bg-gray-300">Kembali ke Menu</button>
            </div>
        </div>
        
        <div id="game-screen" class="screen hidden">
            <div id="round-counter"></div>
            <button id="stop-game-btn" class="hidden absolute top-4 right-4 bg-red-500 text-white text-xs font-bold py-2 px-3 rounded-full hover:bg-red-600 transition z-10">Hentikan</button>
            <div class="player-area">
                <p class="text-gray-500 text-lg">Lawan</p>
                <p class="font-title text-3xl text-gray-800" id="opponent-score">0</p>
                <div id="opponent-choice-display" class="font-title mt-2">?</div>
            </div>
            <div class="flex flex-col items-center space-y-4">
                <button class="choice-btn" data-choice="rock"><img src="./images/rock.png" alt="Batu"></button>
                <button class="choice-btn" data-choice="paper"><img src="./images/paper.png" alt="Kertas"></button>
                <button class="choice-btn" data-choice="scissors"><img src="./images/scissors.png" alt="Gunting"></button>
            </div>
            <div class="player-area">
                <p class="font-title text-3xl text-gray-800" id="my-score">0</p>
                <p class="text-gray-500 text-lg">Kamu</p>
            </div>
        </div>
        
        <div id="result-popup" class="modal-overlay hidden"><div class="modal-card"><button id="close-popup-btn" class="close-btn">&times;</button><h2 id="result-text" class="font-title text-4xl text-gray-800 mb-2"></h2><img id="result-image" src="" alt="Hasil" class="w-32 h-32 mx-auto my-4"><div id="result-choices-display"></div></div></div>
        <div id="summary-modal" class="modal-overlay hidden"><div class="modal-card"><h2 class="font-title text-4xl text-gray-800 mb-4">Permainan Selesai</h2><div id="summary-details" class="space-y-4 text-left"></div><button id="new-game-btn" class="w-full h-[52px] flex justify-center items-center text-white rounded-lg primary-btn text-lg tracking-wider mt-6">Mulai Permainan Baru</button></div></div>
        <div id="settings-modal" class="modal-overlay hidden bg-black bg-opacity-50 z-50"><div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm m-4 relative"><button id="close-settings-btn" class="close-btn">&times;</button><h2 class="text-2xl text-gray-800 mb-6 text-center">Pengaturan Sulap</h2><form id="settings-form" class="space-y-4"><div><label class="font-semibold text-gray-600">Total Ronde</label><input id="total-rounds-input" type="number" min="1" value="5" class="w-full p-2 mt-1 border-2 rounded-lg settings-input"></div><div id="target-outcomes-inputs" class="grid grid-cols-3 gap-2"><div><label class="font-semibold text-gray-600">Menang</label><input id="wins-input" type="number" min="0" value="2" class="w-full p-2 mt-1 border-2 rounded-lg settings-input"></div><div><label class="font-semibold text-gray-600">Kalah</label><input id="losses-input" type="number" min="0" value="2" class="w-full p-2 mt-1 border-2 rounded-lg settings-input"></div><div><label class="font-semibold text-gray-600">Seri</label><input id="draws-input" type="number" min="0" value="1" class="w-full p-2 mt-1 border-2 rounded-lg settings-input"></div></div><div><label class="font-semibold text-gray-600">Mode Permainan</label><div class="mt-2 space-y-2"><label class="flex items-center p-3 bg-gray-50 rounded-lg border-2 border-gray-200 has-[:checked]:border-orange-400"><input type="radio" name="magic-mode" value="peek" class="h-4 w-4 text-orange-500 focus:ring-orange-400"><span class="ml-3 text-gray-700">Peek Mode (Intip Pilihan Lawan)</span></label><label class="flex items-center p-3 bg-gray-50 rounded-lg border-2 border-gray-200 has-[:checked]:border-orange-400"><input type="radio" name="magic-mode" value="magician" checked class="h-4 w-4 text-orange-500 focus:ring-orange-400"><span class="ml-3 text-gray-700">Magician Mode (Otomatis)</span></label></div></div><button type="submit" class="w-full h-[52px] flex justify-center items-center text-white rounded-lg primary-btn text-lg tracking-wider !mt-6">Simpan Pengaturan</button></form></div></div>

        <div id="notification"></div>
        <p class="absolute bottom-2 w-full text-center text-xs text-gray-400 pointer-events-none">Concepted by Heri Sanjaya</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp, onSnapshot, query, where, getDocs, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAm9YiApr6CKGxZx0bCt0en_3Mu3aG93Jg", authDomain: "rock-paper-scissors-prediction.firebaseapp.com", projectId: "rock-paper-scissors-prediction", storageBucket: "rock-paper-scissors-prediction.appspot.com", messagingSenderId: "342279845813", appId: "1:342279845813:web:d11c73a0e4bab96fed8bfc" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let unsubscribeGameListener = null;
        let currentGameId = null;
        let magicSettings = null;
        let magicianPlan = [];
        let currentRound = 0;

        const screens = { loading: document.getElementById('loading-screen'), auth: document.getElementById('auth-screen'), menu: document.getElementById('menu-screen'), waiting: document.getElementById('waiting-screen'), game: document.getElementById('game-screen') };
        const loadingText = document.getElementById('loading-text');
        const registerForm = document.getElementById('register-form');
        const loginForm = document.getElementById('login-form');
        const showLoginLink = document.getElementById('show-login');
        const showRegisterLink = document.getElementById('show-register');
        const loginPrompt = document.getElementById('login-prompt');
        const registerPrompt = document.getElementById('register-prompt');
        const notification = document.getElementById('notification');
        const userEmailSpan = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const createGameBtn = document.getElementById('create-game-btn');
        const qrCodeContainer = document.getElementById('qrcode');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const stopGameBtn = document.getElementById('stop-game-btn');
        const myScoreEl = document.getElementById('my-score');
        const opponentScoreEl = document.getElementById('opponent-score');
        const opponentChoiceDisplay = document.getElementById('opponent-choice-display');
        const choiceBtns = document.querySelectorAll('.choice-btn');
        const resultPopup = document.getElementById('result-popup');
        const resultText = document.getElementById('result-text');
        const resultImage = document.getElementById('result-image');
        const resultChoicesDisplay = document.getElementById('result-choices-display');
        const closePopupBtn = document.getElementById('close-popup-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const settingsForm = document.getElementById('settings-form');
        const gameScreen = document.getElementById('game-screen');
        const roundCounterEl = document.getElementById('round-counter');
        const summaryModal = document.getElementById('summary-modal');
        const summaryDetails = document.getElementById('summary-details');
        const newGameBtn = document.getElementById('new-game-btn');
        const targetOutcomesInputs = document.getElementById('target-outcomes-inputs');
        const magicModeRadios = document.querySelectorAll('input[name="magic-mode"]');

        function showScreen(screenElement) { Object.values(screens).forEach(s => s.classList.add('hidden')); if(screenElement) screenElement.classList.remove('hidden'); }
        function showNotification(message, isError = false) { notification.textContent = message; notification.style.backgroundColor = isError ? '#EF4444' : '#10B981'; notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 3000); }

        async function preloadAssets() { const images = ['./images/rock.png', './images/paper.png', './images/scissors.png', './images/win.png', './images/lose.png', './images/draw.png']; await Promise.all(images.map(src => new Promise((resolve, reject) => { const img = new Image(); img.src = src; img.onload = resolve; img.onerror = () => reject(new Error(`Gagal memuat gambar: ${src}`)); }))); }
        
        async function loadMagicSettings(uid) {
            const settingsRef = doc(db, 'user_settings', uid);
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists()) {
                magicSettings = docSnap.data();
                document.getElementById('total-rounds-input').value = magicSettings.totalRounds;
                document.getElementById('wins-input').value = magicSettings.targetWins;
                document.getElementById('losses-input').value = magicSettings.targetLosses;
                document.getElementById('draws-input').value = magicSettings.targetDraws;
                document.querySelector(`input[name="magic-mode"][value="${magicSettings.mode}"]`).checked = true;
            } else {
                magicSettings = { totalRounds: 5, targetWins: 2, targetLosses: 2, targetDraws: 1, mode: 'magician' };
            }
            magicSettings.isActive = false; 
            updateSettingsUI(magicSettings.mode);
        }

        async function saveMagicSettings() {
            const mode = document.querySelector('input[name="magic-mode"]:checked').value;
            const totalRounds = parseInt(document.getElementById('total-rounds-input').value);
            const wins = parseInt(document.getElementById('wins-input').value);
            const losses = parseInt(document.getElementById('losses-input').value);
            const draws = parseInt(document.getElementById('draws-input').value);
            
            if (mode === 'magician' && (wins + losses + draws !== totalRounds)) { showNotification("Jumlah hasil harus sama dengan total ronde.", true); return false; }

            const newSettings = { totalRounds, mode, targetWins: wins, targetLosses: losses, targetDraws: draws };
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("Pengguna tidak login");
                await setDoc(doc(db, 'user_settings', user.uid), newSettings);
                magicSettings = { ...newSettings, isActive: false };
                showNotification("Pengaturan disimpan!", false);
                return true;
            } catch (error) { console.error("Gagal menyimpan:", error); showNotification("Gagal menyimpan pengaturan.", true); return false; }
        }

        function activateMagic() {
            if (!magicSettings) return;
            
            magicSettings.isActive = true;
            const originalContent = opponentChoiceDisplay.innerHTML;
            opponentChoiceDisplay.innerHTML = `<span style="animation: sparkle-in-circle 1.2s ease-in-out;">✨</span>`;
            setTimeout(() => {
                if(opponentChoiceDisplay.innerHTML.includes('sparkle')) {
                   opponentChoiceDisplay.innerHTML = originalContent;
                }
            }, 1200);

            if (magicSettings.mode === 'magician') {
                magicianPlan = [];
                for (let i = 0; i < magicSettings.targetWins; i++) magicianPlan.push('win');
                for (let i = 0; i < magicSettings.targetLosses; i++) magicianPlan.push('lose');
                for (let i = 0; i < magicSettings.targetDraws; i++) magicianPlan.push('draw');
                for (let i = magicianPlan.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [magicianPlan[i], magicianPlan[j]] = [magicianPlan[j], magicianPlan[i]]; }
            }
        }

        function getMagicianChoice(opponentChoice, desiredOutcome) {
            if (desiredOutcome === 'win') { if (opponentChoice === 'rock') return 'paper'; if (opponentChoice === 'paper') return 'scissors'; return 'rock'; } 
            else if (desiredOutcome === 'lose') { if (opponentChoice === 'rock') return 'scissors'; if (opponentChoice === 'paper') return 'rock'; return 'paper'; }
            return opponentChoice;
        }
        
        function updateChoiceHighlight(choice) {
            choiceBtns.forEach(b => b.classList.remove('selected'));
            const btnToSelect = document.querySelector(`.choice-btn[data-choice="${choice}"]`);
            if (btnToSelect) btnToSelect.classList.add('selected');
        }

        onAuthStateChanged(auth, async (user) => {
            try {
                loadingText.textContent = 'Memuat aset...';
                await preloadAssets();
                loadingText.textContent = 'Memuat...';
                if (user) {
                    getDocs(query(collection(db, "games"), where("player1.uid", "==", user.uid))).then(snap => snap.forEach(gameDoc => deleteDoc(doc(db, "games", gameDoc.id))));
                    if (!user.isAnonymous) { await loadMagicSettings(user.uid); userEmailSpan.textContent = user.email; showScreen(screens.menu); } 
                    else { signOut(auth).finally(() => showScreen(screens.auth)); }
                } else { showScreen(screens.auth); }
            } catch(error) { console.error("Gagal inisialisasi:", error); loadingText.textContent = 'Gagal memuat aset.'; showNotification(error.message || 'Gagal memuat aset.', true);
            } finally { screens.loading.classList.add('hidden'); }
        });

        function startGame(gameId) {
            currentRound = 0;
            if (magicSettings) magicSettings.isActive = false;
            currentGameId = gameId;

            if(unsubscribeGameListener) unsubscribeGameListener();
            const gameDocRef = doc(db, "games", gameId);

            unsubscribeGameListener = onSnapshot(gameDocRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    if(unsubscribeGameListener) { unsubscribeGameListener(); unsubscribeGameListener = null; }
                    currentGameId = null;
                    if (screens.game.classList.contains('hidden') && screens.waiting.classList.contains('hidden')) return;
                    showNotification("Permainan telah berakhir.", false);
                    if (auth.currentUser && !auth.currentUser.isAnonymous) showScreen(screens.menu);
                    return;
                }

                const game = docSnap.data();
                const me = game.player1;
                const opponent = game.player2;
                
                stopGameBtn.classList.toggle('hidden', !(me && me.uid === auth.currentUser.uid));

                if (!me || !opponent) { showScreen(screens.waiting); return; }
                if(screens.game.classList.contains('hidden')) showScreen(screens.game);
                
                myScoreEl.textContent = me.results?.wins ?? 0;
                opponentScoreEl.textContent = opponent.results?.wins ?? 0;

                if(magicSettings && magicSettings.isActive) {
                    roundCounterEl.textContent = `Ronde: ${currentRound + 1} / ${magicSettings.totalRounds}`;
                    await updateDoc(gameDocRef, { "magicSettings": magicSettings, "currentRound": currentRound });
                } else {
                    roundCounterEl.textContent = '';
                }
                
                if (magicSettings?.isActive && magicSettings.mode === 'peek' && opponent.choice && !me.choice) {
                    opponentChoiceDisplay.innerHTML = `<img src="./images/${opponent.choice}.png" alt="${opponent.choice}">`;
                    opponentChoiceDisplay.classList.remove("bg-green-200", "text-green-600");
                } else if (opponent.choice) {
                    opponentChoiceDisplay.textContent = '✓';
                    opponentChoiceDisplay.classList.add("bg-green-200", "text-green-600");
                } else {
                    opponentChoiceDisplay.innerHTML = `?`;
                    opponentChoiceDisplay.classList.remove("bg-green-200", "text-green-600");
                }

                if (game.gameState === 'finished') {
                    showResultPopup(game);
                } else {
                    resultPopup.classList.add('hidden');
                }

                if (game.gameState === 'waiting' && me.choice && opponent.choice) {
                    if (magicSettings?.isActive && magicSettings.mode === 'magician' && me.choice === 'chosen') {
                        const desiredOutcome = magicianPlan[currentRound];
                        const magicalChoice = getMagicianChoice(opponent.choice, desiredOutcome);
                        updateChoiceHighlight(magicalChoice);
                        setTimeout(() => {
                           updateDoc(doc(db, 'games', gameId), { 'player1.choice': magicalChoice });
                        }, 500);
                    } else if (me.choice !== 'chosen') {
                        determineWinner(gameId, game);
                    }
                }
                
                choiceBtns.forEach(btn => btn.classList.toggle('disabled', !!me.choice || game.gameState === 'finished'));
            });
        }
        
        function showResultPopup(game) {
            const p1c = game.player1.choice;
            const p2c = game.player2.choice;
            let winner = 'draw';
            if ((p1c === 'rock' && p2c === 'scissors') || (p1c === 'paper' && p2c === 'rock') || (p1c === 'scissors' && p2c === 'paper')) { winner = 'player1'; } 
            else if (p1c !== p2c) { winner = 'player2'; }

            resultText.textContent = (winner === 'draw') ? 'SERI!' : (winner === 'player1' ? 'KAMU MENANG!' : 'KAMU KALAH!');
            resultImage.src = (winner === 'draw') ? './images/draw.png' : (winner === 'player1' ? './images/win.png' : './images/lose.png');
            resultChoicesDisplay.innerHTML = `<img src="./images/${p1c}.png" alt="${p1c}"><span class="font-title text-2xl text-gray-400">vs</span><img src="./images/${p2c}.png" alt="${p2c}">`;
            resultPopup.classList.remove('hidden');
        }
        
        function showSummaryPopup(game) {
            resultPopup.classList.add('hidden'); // Menutup modal hasil
            const me = game.player1;
            const opponent = game.player2;
            const myResults = me.results || { wins: 0, losses: 0, draws: 0 };
            const opponentResults = opponent.results || { wins: 0, losses: 0, draws: 0 };

            summaryDetails.innerHTML = `
                <div class="border-t border-b py-2">
                    <h3 class="font-semibold text-lg text-gray-700">Skor Kamu</h3>
                    <p class="text-gray-500">Menang: ${myResults.wins}, Kalah: ${myResults.losses}, Seri: ${myResults.draws}</p>
                </div>
                <div>
                    <h3 class="font-semibold text-lg text-gray-700">Skor Lawan</h3>
                    <p class="text-gray-500">Menang: ${opponentResults.wins}, Kalah: ${opponentResults.losses}, Seri: ${opponentResults.draws}</p>
                </div>`;
            summaryModal.classList.remove('hidden');
        }

        async function determineWinner(gameId, game) {
            const p1c = game.player1.choice; const p2c = game.player2.choice;
            let winner = 'draw';
            if ((p1c === 'rock' && p2c === 'scissors') || (p1c === 'paper' && p2c === 'rock') || (p1c === 'scissors' && p2c === 'paper')) { winner = 'player1'; } 
            else if (p1c !== p2c) { winner = 'player2'; }

            const updates = { gameState: 'finished' };
            if (winner === 'player1') { updates['player1.results.wins'] = increment(1); updates['player2.results.losses'] = increment(1); } 
            else if (winner === 'player2') { updates['player1.results.losses'] = increment(1); updates['player2.results.wins'] = increment(1); } 
            else { updates['player1.results.draws'] = increment(1); updates['player2.results.draws'] = increment(1); }
            await updateDoc(doc(db, 'games', gameId), updates);
        }

        async function resetRound(gameData) {
            currentRound++;
            if (magicSettings && magicSettings.isActive && currentRound >= magicSettings.totalRounds) {
                showSummaryPopup(gameData);
                return;
            }
            if (currentGameId) {
                await updateDoc(doc(db, 'games', currentGameId), { 'player1.choice': null, 'player2.choice': null, 'gameState': 'waiting' });
            }
        }
        
        async function stopGame() {
            if (currentGameId) {
                const gameIdToDelete = currentGameId;
                if(unsubscribeGameListener) { unsubscribeGameListener(); unsubscribeGameListener = null; }
                currentGameId = null;
                try { await deleteDoc(doc(db, "games", gameIdToDelete)); } catch (e) { console.error("Gagal menghapus game:", e); }
                showScreen(screens.menu);
            }
        }
        
        function updateSettingsUI(mode) { targetOutcomesInputs.style.display = mode === 'magician' ? 'grid' : 'none'; }
        magicModeRadios.forEach(radio => radio.addEventListener('change', (e) => updateSettingsUI(e.target.value)));
        
        settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        settingsForm.addEventListener('submit', async (e) => { e.preventDefault(); if (await saveMagicSettings()) { settingsModal.classList.add('hidden'); } });
        
        let lastTapTime = 0;
        gameScreen.addEventListener('touchend', (e) => {
            if (e.target.closest('button')) return;
            const currentTime = new Date().getTime();
            if (currentTime - lastTapTime < 300) { e.preventDefault(); activateMagic(); }
            lastTapTime = currentTime;
        });
        gameScreen.addEventListener('dblclick', (e) => { if (e.target.closest('button')) return; activateMagic(); });

        choiceBtns.forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!currentGameId || btn.classList.contains('disabled')) return;
                const choice = btn.dataset.choice;
                updateChoiceHighlight(choice);
                let finalChoice = choice;
                if (magicSettings && magicSettings.isActive && magicSettings.mode === 'magician') { finalChoice = 'chosen'; }
                await updateDoc(doc(db, 'games', currentGameId), { 'player1.choice': finalChoice });
            });
        });
        
        closePopupBtn.addEventListener('click', async () => {
            resultPopup.classList.add('hidden');
            const gameRef = doc(db, 'games', currentGameId);
            const gameSnap = await getDoc(gameRef);
            if(gameSnap.exists()) resetRound(gameSnap.data());
        });

        newGameBtn.addEventListener('click', () => { summaryModal.classList.add('hidden'); stopGame(); });

        createGameBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const button = e.currentTarget; button.disabled = true;
            try {
                const gameData = {
                    player1: { uid: auth.currentUser.uid, email: auth.currentUser.email, choice: null, results: { wins: 0, losses: 0, draws: 0 } },
                    player2: null, gameState: 'waiting', createdAt: serverTimestamp()
                };
                const gameDocRef = await addDoc(collection(db, "games"), gameData);
                const joinUrl = `${window.location.href.split('?')[0].replace(/index\.html$/, '')}guest.html?game=${gameDocRef.id}`;
                qrCodeContainer.innerHTML = '';
                new QRCode(qrCodeContainer, { text: joinUrl, width: 192, height: 192 });
                startGame(gameDocRef.id);
            } catch (error) { console.error("Error creating game:", error); showNotification("Gagal membuat game.", true); showScreen(screens.menu);
            } finally { button.disabled = false; }
        });

        stopGameBtn.addEventListener('click', stopGame);
        backToMenuBtn.addEventListener('click', stopGame);
        logoutBtn.addEventListener('click', () => { if (unsubscribeGameListener) unsubscribeGameListener(); signOut(auth).catch(error => showNotification('Gagal keluar.', true)); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); loginPrompt.classList.add('hidden'); registerPrompt.classList.remove('hidden'); });
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); registerPrompt.classList.add('hidden'); loginPrompt.classList.remove('hidden'); });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; const licenseCode = document.getElementById('license-code').value.trim();
            const button = registerForm.querySelector('button'); const originalButtonText = 'Daftar';
            if (!licenseCode) { showNotification('Kode lisensi kosong.', true); return; }
            button.disabled = true; button.innerHTML = `<div class="btn-loader"></div>`;
            try {
                const licenseRef = doc(db, 'license_codes', licenseCode);
                const licenseSnap = await getDoc(licenseRef);
                if (!licenseSnap.exists() || licenseSnap.data().isUsed) { throw new Error('Kode lisensi tidak valid.'); }
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateDoc(licenseRef, { isUsed: true, usedBy: userCredential.user.uid, usedAt: serverTimestamp() });
                showNotification('Pendaftaran berhasil!', false);
            } catch (error) { showNotification(error.message || 'Gagal mendaftar.', true);
            } finally { button.disabled = false; button.innerHTML = originalButtonText; }
        });
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value;
            const button = loginForm.querySelector('button'); const originalButtonText = 'Login';
            button.disabled = true; button.innerHTML = `<div class="btn-loader"></div>`;
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (error) { showNotification('Email atau password salah.', true); } 
            finally { button.disabled = false; button.innerHTML = originalButtonText; }
        });

    </script>
</body>
</html>
